\section{API}

Toutes les requêtes sauf mention contraire sont en POST avec pour type mime "text/json". Le préfixe au quel on concatenne les chemins décrits ci dessous est de la forme \verb|http://mon.parapheur.fr/alfresco/service|

\subsection{Authentification}

\subsubsection{login}
\shadowbox{
\verb|/parapheur/api/login|
}\\

Cet appel ne nécessite aucune authentification (c'est d'ailleurs le seul). Une fois le ticket extrait du retour il doit être passé dans la query String\footnote{Par exemple: alf\_ticket=TICKET\_6a04816348fe8d9aab05ec7a43cfed22bdcdedd2} pour toutes les autres requêtes.

\begin{codesnippet}
\inputminted[frame=single,linenos,fontsize=\footnotesize]{javascript}{extraits/login_in.js}
\caption{Login requête entrante}
\label{snip:login_in}
\end{codesnippet}


\subsubsection{logout}
\shadowbox{
\verb|/parapheur/api/logout|
}\\

\begin{codesnippet}
\inputminted[frame=single,linenos,fontsize=\footnotesize]{javascript}{extraits/logout_in.js}
\caption{Logout requête entrante}
\label{snip:logout_in}
\end{codesnippet}

\begin{codesnippet}
\inputminted[frame=single,linenos,fontsize=\footnotesize]{javascript}{extraits/logout_out.js}
\caption{Logout retour}
\label{snip:logout_out}
\end{codesnippet}


\subsubsection{validate}

\subsection{Bureaux}

\subsubsection{getBureaux}
\shadowbox{
\verb|/parapheur/api/getBureaux|
}\\

Retourne la liste des bureaux dont l'utilisateur passé en paramètre est propriétaire. (voir extraits \ref{snip:getBureaux_in} et \ref{snip:getBureaux_out}) 

\begin{codesnippet}
\inputminted[frame=single,linenos,fontsize=\footnotesize]{javascript}{extraits/getBureaux_in.js}
\caption{getBureaux requête entrante}
\label{snip:getBureaux_in}
\end{codesnippet}

\subsubsection{getDossiersHeaders}
\shadowbox{
\verb|/parapheur/api/getDossiersHeaders|
}\\

\paragraph{Entêtes de dossiers paginées}

Retourne une liste d'entêtes de dossiers issus de la bannette ``a-traiter''. (voir extraits \ref{snip:getDossiersHeaders_in} et \ref{snip:getDossiersHeaders_out}).

Lorsque l'on limite le nombre ($n$) de résultats \verb|getDossiersHeaders| retourne au plus $n + 1$ résultats afin d'indiquer une page suivante potentielle. Si \verb|pageSize| vaut 0 alors tout les résultats sont retournés.

\begin{codesnippet}
\inputminted[frame=single,linenos,fontsize=\footnotesize]{javascript}{extraits/getDossiersHeaders_in.js}
\caption{getDossiersHeaders requête entrante}
\label{snip:getDossiersHeaders_in}
\end{codesnippet}

\paragraph{Filtres}
Dans la requête des filtres il est possible d'utiliser les variables suivantes\ref{table:filterable_fields} le type de la donnée est donné à titre indicatif car représenté sous forme de \verb|STRING| dans l'élément filtres de la requête.


\begin{figure}[H]
	\begin{center}
\begin{tabular}{c|c|c}
	\hline
	Nom & Type & Examples de valeurs \\
	\hline
	cm:name & STRING & re7 07\\
	ph:recuperable & BOOLEAN & false \\
	ph:reading-mandatory & BOOLEAN & false\\
	ph:signature-papier & BOOLEAN & false\\
	ph:tdtProtocole & STRING  & ACTES\\
	ph:dateLimite & DATE & null\\
	ph:soustypeMetier & STRING & Arrete du personel \\
	ph:confidentiel & BOOLEAN & false \\
	ph:termine & BOOLEAN & false \\
	ph:tdtNom & STRING & $S^2LOW$ \\
	ph:typeSignature & STRING & CMS\\
	ph:digital-signature-mandatory & BOOLEAN & false \\
	ph:sigFormat & STRING & PKCS$\sharp$7/single \\
	cm:modified & DATE & 2012-21-05 \\
	ph:typeMetier & STRING & Actes \\
	cm:created & DATE & 2012-17-01
	
\end{tabular}
\end{center}
\caption{Filtres potentiels}
\label{table:filterable_fields}

\end{figure}

Par exemple si l'on veut tout les dossiers commençant par ``Test''\footnote{On notera l'utilisation du caractère joker *} et ayant pour type ``HELIOS'' et sousType ``depense''
\begin{codesnippet}
\begin{minted}[frame=single,linenos,fontsize=\footnotesize]{javascript}
	"filtres": {
		"cm:name" : "Test*",
		"ph:typeMetier" : "HELIOS",
		"ph:soustypeMetier" : "depense"
	}
\end{minted}
\caption{Exemple de filtre à prédicats multiples}
\end{codesnippet}


\paragraph{Filtres sur les champs de type date}

Les champs de type date peuvent être filtrés à l'aide d'un intervalle de date\footnote{Il est fort probable que cela fonctionne avec d'autres types énumérés par exemple les entiers}.

\begin{codesnippet}
\begin{minted}[frame=single,linenos,fontsize=\footnotesize]{javascript}
	"filtres": {
		"cm:created" : "[2012-06-01 TO NOW]",
	}
	
	"filtres": {
		"cm:created" : "[NOW TO 2012-06-01]",
	}
	
	"filtres": {
		"cm:created" : "[2012-06-01 TO 2012-06-06]",
	}
\end{minted}
\caption{Exemple de filtre sur des champs de type date}
\end{codesnippet}

\paragraph{Filtres Complexes}
Il est possible de faire des filtres complexes contenant des clauses ``OR'' et ``AND''.

\begin{codesnippet}
\inputminted[frame=single,linenos,fontsize=\footnotesize]{javascript}{extraits/getDossiersHeaders_search_complex_in.js}
\caption{getDossiersHeaders Complex filters}
\label{snip:getTypologie_in}
\end{codesnippet}

\paragraph{Spécification du Parent virtuel}

Par défaut les filtres retournent des résultats sur les dossiers provenant de la corbeille "a-traiter". Il est désormais possible de
choisir la corbeille (y compris virtuelle). Le tableau suivant\ref{table:parent_values} récapitule les différentes corbeilles possibles.

\begin{figure}
\begin{center}
\begin{tabular}{c|p{7cm}}
	\hline
	Corbeille & Déscription \\
	\hline
        \verb|en-preparation| & contient les dossiers qui n'ont pas été encore émis  \\
        \verb|a-traiter| & contient les dossier que l'utilisateur doit traiter (signer, viser, etc ...) \\
        \verb|a-archiver| & contient les dossiers qui sont en fin de circuit ou à une étape d'archivage \\
        \verb|retournes| & contient les dossiers rejetés \\
        \verb|en-cours| & contient les dossiers emis par le proprietaire du bureau et qui suivent un circuit \\
        \verb|a-venir| & contient les dossiers qui vont arriver dans le bureau \\
        \verb|recuperables| & contient les dossiers récupérables (ie que l'on vient de viser) \\
        \verb|secretariat| & contient les dossiers envoyés au secretariat \\
        \verb|en-retard| & contient les dossiers dont la date limite < date du jour (valable uniquement pour le bureau emetteur) \\
        \verb|a-imprimer| & contient les dossiers à imprimer par la secretaire


\end{tabular}
\end{center}
\caption{Description des valeurs possibles de PARENT}
\label{table:parent_values}
\end{figure}




\subsubsection{getTypologie}
\shadowbox{\verb|/parapheur/api/getTypologie|
}\\

Retourne la typologie accessible au bureau passé en paramètre (voir extrait \ref{snip:getTypologie_out}).

\begin{codesnippet}
\inputminted[frame=single,linenos,fontsize=\footnotesize]{javascript}{extraits/getTypologie_in.js}
\caption{getTypologie in}
\label{snip:getTypologie_in}
\end{codesnippet}







\subsection{Dossiers}

\subsubsection{getDossier}
\shadowbox{\verb|/parapheur/api/getDossier|
}\\


Le flag \verb|recuperable| indique si le dernier acteur qui a effectué une action de validation récupérable (visa) peut récupérer le dossier.

Le champ \verb|nomTdt| correspond au nom du tiers de télétransmission renseigné dans le sous type associé au dossier (FAST, S2LOW ou SRCI).

Le champ \verb|protocoleTdt| correspond au protocole du tiers de télétransmission sélectionné pour ce dossier (HELIOS ou ACTES).

Le champ \verb|type| correspond au type métier du dossier.

Le champ \verb|sousType| correspond au sous type métier du dossier.

Le champ \verb|lectureObligatoire| signifie que la lecture du document principal est obligatoire à l'étape de signature.

Le champ \verb|signatureNumeriqueObligatoire| signifie que la signature électronique est obligatoire (pas de signature "papier")

La partie documents de la réponse à \verb|getDossier| contient un champ \verb|downloadUrl| (pour avoir le chemin complet on effectue la concaténation du préfixe et de l'url\footnote{Dans le cas présent ça donne: http://mon.parapheur.fr/alfresco/service/api/node/workspace/SpacesStore/1b4b7715-c053-4cea-bed7-5be34373d565/content?alf\_ticket=TICKET\_6a04816348fe8d9aab05ec7a43cfed22bdcdedd2}) un champ \verb|size| en octets qui représente la taille du document éventuellement un champ \verb|visuelPdfUrl| qui renvoie une version pdf du document (voir extrait \ref{snip:getDossier_out}). Un dossier contient un document principal (le premier de la liste) et éventuellement des annexes.

\begin{codesnippet}
\inputminted[frame=single,linenos,fontsize=\footnotesize]{javascript}{extraits/getDossier_in.js}
\caption{getDossier in}
\label{snip:getDossier_out}
\end{codesnippet}

\subsubsection{visa}
\shadowbox{\verb|/parapheur/api/visa|
}\\

Ne retourne rien si ce n'est des codes d'erreur Http lors d'un échec notamment 403 (Forbidden) ou 500 (Internal Server Error)

\begin{codesnippet}
\inputminted[frame=single,linenos,fontsize=\footnotesize]{javascript}{extraits/visa_in.js}
\caption{visa in}
\label{snip:visa_in}
\end{codesnippet}

\subsubsection{reject}
\shadowbox{\verb|/parapheur/api/reject|
}\\

Ne retourne rien si ce n'est des codes d'erreur Http lors d'un échec notamment 403 (Forbidden) ou 500 (Internal Server Error)

\begin{codesnippet}
\inputminted[frame=single,linenos,fontsize=\footnotesize]{javascript}{extraits/reject_in.js}
\caption{reject in}
\label{snip:reject_in}
\end{codesnippet}
